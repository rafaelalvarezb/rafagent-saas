<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Gestión de Zona Horaria - RafAgent</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .timezone-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .timezone-group {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .timezone-group h4 {
            margin-top: 0;
            color: #333;
        }
        .timezone-option {
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #eee;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .timezone-option:hover {
            background-color: #f8f9fa;
        }
        .timezone-option.selected {
            background-color: #007bff;
            color: white;
        }
        .current-timezone {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .scenario {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌍 Test de Gestión de Zona Horaria - RafAgent</h1>
        
        <div class="test-section info">
            <h3>📋 Nueva Funcionalidad Implementada</h3>
            <ul>
                <li>✅ <strong>Detección automática:</strong> Detecta la zona horaria del usuario al registrarse</li>
                <li>✅ <strong>Selección manual:</strong> El usuario puede cambiar su zona horaria</li>
                <li>✅ <strong>Conversión inteligente:</strong> Maneja correctamente las conversiones entre zonas horarias</li>
                <li>✅ <strong>Horario de verano:</strong> Considera automáticamente el DST</li>
                <li>✅ <strong>Base de datos completa:</strong> Soporte para 25+ zonas horarias principales</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🧪 Test de Detección Automática</h3>
            <p>Prueba la detección automática de zona horaria:</p>
            
            <button onclick="testAutoDetection()">Detectar Mi Zona Horaria</button>
            <button onclick="testTimezoneConversion()">Probar Conversión de Horarios</button>
            <button onclick="clearLog()">Limpiar Log</button>
            
            <div id="detection-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>🌍 Selector de Zona Horaria</h3>
            <p>Simula la interfaz para que el usuario seleccione su zona horaria:</p>
            
            <div class="current-timezone">
                <strong>Zona horaria actual:</strong> <span id="current-timezone">Detectando...</span>
            </div>
            
            <div class="timezone-selector">
                <div class="timezone-group">
                    <h4>🌎 Américas</h4>
                    <div class="timezone-option" data-timezone="America/Mexico_City">🇲🇽 México (GMT-6)</div>
                    <div class="timezone-option" data-timezone="America/New_York">🇺🇸 Nueva York (GMT-5)</div>
                    <div class="timezone-option" data-timezone="America/Los_Angeles">🇺🇸 Los Ángeles (GMT-8)</div>
                    <div class="timezone-option" data-timezone="America/Argentina/Buenos_Aires">🇦🇷 Buenos Aires (GMT-3)</div>
                    <div class="timezone-option" data-timezone="America/Sao_Paulo">🇧🇷 São Paulo (GMT-3)</div>
                </div>
                
                <div class="timezone-group">
                    <h4>🌍 Europa & Asia</h4>
                    <div class="timezone-option" data-timezone="Europe/London">🇬🇧 Londres (GMT+0)</div>
                    <div class="timezone-option" data-timezone="Europe/Paris">🇫🇷 París (GMT+1)</div>
                    <div class="timezone-option" data-timezone="Asia/Tokyo">🇯🇵 Tokio (GMT+9)</div>
                    <div class="timezone-option" data-timezone="Asia/Shanghai">🇨🇳 Shanghai (GMT+8)</div>
                    <div class="timezone-option" data-timezone="Asia/Kolkata">🇮🇳 India (GMT+5.5)</div>
                </div>
            </div>
            
            <button onclick="saveTimezone()">💾 Guardar Zona Horaria</button>
            <div id="timezone-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>🎯 Escenarios de Prueba</h3>
            <p>Prueba los 3 escenarios críticos con diferentes zonas horarias:</p>
            
            <div class="scenario">
                <h4>Escenario 1: Usuario en México, Prospecto en Argentina</h4>
                <p><strong>Usuario:</strong> México (GMT-6) | <strong>Prospecto:</strong> "¿Podemos hablar el viernes a las 2 PM?"</p>
                <button onclick="testScenario1()">Probar Escenario 1</button>
            </div>
            
            <div class="scenario">
                <h4>Escenario 2: Usuario en Nueva York, Prospecto en México</h4>
                <p><strong>Usuario:</strong> Nueva York (GMT-5) | <strong>Prospecto:</strong> "¿Puede ser el viernes a las 9 AM?"</p>
                <button onclick="testScenario2()">Probar Escenario 2</button>
            </div>
            
            <div class="scenario">
                <h4>Escenario 3: Usuario en Los Ángeles, Prospecto en Londres</h4>
                <p><strong>Usuario:</strong> Los Ángeles (GMT-8) | <strong>Prospecto:</strong> "¿Podemos hablar el viernes a las 3 PM?"</p>
                <button onclick="testScenario3()">Probar Escenario 3</button>
            </div>
            
            <div id="scenario-log" class="log"></div>
        </div>

        <div class="test-section success">
            <h3>✅ Instrucciones para Probar en Producción</h3>
            <ol>
                <li><strong>Despliega los cambios:</strong> Los archivos ya están actualizados</li>
                <li><strong>Prueba con diferentes usuarios:</strong>
                    <ul>
                        <li>Usuario en México → Debería detectar "America/Mexico_City"</li>
                        <li>Usuario en Nueva York → Debería detectar "America/New_York"</li>
                        <li>Usuario en Buenos Aires → Debería detectar "America/Argentina/Buenos_Aires"</li>
                    </ul>
                </li>
                <li><strong>Prueba la programación de reuniones:</strong>
                    <ul>
                        <li>Con cada usuario, programa una reunión</li>
                        <li>Verifica que se agende en la zona horaria correcta del usuario</li>
                        <li>Verifica que el prospecto reciba la invitación con la hora correcta</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        let selectedTimezone = null;
        let currentUserTimezone = null;

        function log(message, type = 'info', logId = 'detection-log') {
            const logDiv = document.getElementById(logId);
            const timestamp = new Date().toLocaleString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('detection-log').innerHTML = '';
            document.getElementById('timezone-log').innerHTML = '';
            document.getElementById('scenario-log').innerHTML = '';
        }

        function testAutoDetection() {
            log('🔍 Probando detección automática de zona horaria...');
            
            try {
                // Simular detección automática
                const detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
                currentUserTimezone = detected;
                
                log(`✅ Zona horaria detectada: ${detected}`, 'success');
                log(`🕐 Hora actual en tu zona: ${new Date().toLocaleString('es-MX', { timeZone: detected })}`);
                
                // Actualizar display
                document.getElementById('current-timezone').textContent = detected;
                
                // Seleccionar automáticamente en el selector
                const timezoneOptions = document.querySelectorAll('.timezone-option');
                timezoneOptions.forEach(option => {
                    if (option.dataset.timezone === detected) {
                        option.classList.add('selected');
                        selectedTimezone = detected;
                    }
                });
                
            } catch (error) {
                log(`❌ Error en detección: ${error.message}`, 'error');
            }
        }

        function testTimezoneConversion() {
            log('🔄 Probando conversión de horarios...');
            
            const testTime = "14:00"; // 2 PM
            const fromTimezone = "America/Argentina/Buenos_Aires"; // GMT-3
            const toTimezone = "America/Mexico_City"; // GMT-6
            
            log(`📅 Hora original: ${testTime} (${fromTimezone})`);
            
            // Simular conversión
            const [hours, minutes] = testTime.split(':').map(Number);
            const fromOffset = -3; // Buenos Aires
            const toOffset = -6; // México
            const offsetDiff = toOffset - fromOffset;
            const newHours = hours + offsetDiff;
            
            const convertedTime = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            log(`✅ Hora convertida: ${convertedTime} (${toTimezone})`);
            log(`📊 Diferencia: ${offsetDiff} horas (${fromTimezone} → ${toTimezone})`);
            
            if (convertedTime === "11:00") {
                log('✅ ¡CONVERSIÓN CORRECTA! 2 PM Buenos Aires = 11 AM México', 'success');
            } else {
                log('❌ ERROR: La conversión no es correcta', 'error');
            }
        }

        // Manejar selección de zona horaria
        document.querySelectorAll('.timezone-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remover selección anterior
                document.querySelectorAll('.timezone-option').forEach(opt => opt.classList.remove('selected'));
                
                // Seleccionar nueva opción
                this.classList.add('selected');
                selectedTimezone = this.dataset.timezone;
                
                log(`🌍 Zona horaria seleccionada: ${selectedTimezone}`, 'info', 'timezone-log');
            });
        });

        function saveTimezone() {
            if (!selectedTimezone) {
                log('❌ Por favor selecciona una zona horaria', 'error', 'timezone-log');
                return;
            }
            
            log(`💾 Guardando zona horaria: ${selectedTimezone}`, 'success', 'timezone-log');
            log(`🕐 Hora actual en la zona seleccionada: ${new Date().toLocaleString('es-MX', { timeZone: selectedTimezone })}`, 'info', 'timezone-log');
            
            // Simular guardado
            currentUserTimezone = selectedTimezone;
            document.getElementById('current-timezone').textContent = selectedTimezone;
        }

        function testScenario1() {
            log('🎯 ESCENARIO 1: Usuario en México, Prospecto en Argentina', 'info', 'scenario-log');
            log('👤 Usuario: México (GMT-6) | 📧 Prospecto: "¿Podemos hablar el viernes a las 2 PM?"', 'info', 'scenario-log');
            
            // Simular que el prospecto dice "2 PM" (asumiendo hora de Argentina)
            const prospectTime = "14:00"; // 2 PM Argentina
            const prospectTimezone = "America/Argentina/Buenos_Aires"; // GMT-3
            const userTimezone = "America/Mexico_City"; // GMT-6
            
            // Convertir 2 PM Argentina a México
            const [hours, minutes] = prospectTime.split(':').map(Number);
            const fromOffset = -3; // Argentina
            const toOffset = -6; // México
            const offsetDiff = toOffset - fromOffset;
            const newHours = hours + offsetDiff;
            const convertedTime = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            log(`🔄 Conversión: 2 PM Argentina → ${convertedTime} México`, 'success', 'scenario-log');
            log(`✅ Reunión agendada para: Viernes ${convertedTime} (hora de México)`, 'success', 'scenario-log');
        }

        function testScenario2() {
            log('🎯 ESCENARIO 2: Usuario en Nueva York, Prospecto en México', 'info', 'scenario-log');
            log('👤 Usuario: Nueva York (GMT-5) | 📧 Prospecto: "¿Puede ser el viernes a las 9 AM?"', 'info', 'scenario-log');
            
            // Simular que el prospecto dice "9 AM" (asumiendo hora de México)
            const prospectTime = "09:00"; // 9 AM México
            const prospectTimezone = "America/Mexico_City"; // GMT-6
            const userTimezone = "America/New_York"; // GMT-5
            
            // Convertir 9 AM México a Nueva York
            const [hours, minutes] = prospectTime.split(':').map(Number);
            const fromOffset = -6; // México
            const toOffset = -5; // Nueva York
            const offsetDiff = toOffset - fromOffset;
            const newHours = hours + offsetDiff;
            const convertedTime = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            log(`🔄 Conversión: 9 AM México → ${convertedTime} Nueva York`, 'success', 'scenario-log');
            log(`✅ Reunión agendada para: Viernes ${convertedTime} (hora de Nueva York)`, 'success', 'scenario-log');
        }

        function testScenario3() {
            log('🎯 ESCENARIO 3: Usuario en Los Ángeles, Prospecto en Londres', 'info', 'scenario-log');
            log('👤 Usuario: Los Ángeles (GMT-8) | 📧 Prospecto: "¿Podemos hablar el viernes a las 3 PM?"', 'info', 'scenario-log');
            
            // Simular que el prospecto dice "3 PM" (asumiendo hora de Londres)
            const prospectTime = "15:00"; // 3 PM Londres
            const prospectTimezone = "Europe/London"; // GMT+0
            const userTimezone = "America/Los_Angeles"; // GMT-8
            
            // Convertir 3 PM Londres a Los Ángeles
            const [hours, minutes] = prospectTime.split(':').map(Number);
            const fromOffset = 0; // Londres
            const toOffset = -8; // Los Ángeles
            const offsetDiff = toOffset - fromOffset;
            const newHours = hours + offsetDiff;
            const convertedTime = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            log(`🔄 Conversión: 3 PM Londres → ${convertedTime} Los Ángeles`, 'success', 'scenario-log');
            log(`✅ Reunión agendada para: Viernes ${convertedTime} (hora de Los Ángeles)`, 'success', 'scenario-log');
        }

        // Test automático al cargar la página
        window.onload = function() {
            log('🚀 Página de test cargada. Haz clic en los botones para probar la gestión de zona horaria.');
            testAutoDetection();
        };
    </script>
</body>
</html>
